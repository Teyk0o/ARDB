name: Sync All Data from Upstream

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync-all-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ===== SYNC ITEMS =====
      - name: Sync Items Data
        id: sync_items
        continue-on-error: true
        run: |
          mkdir -p temp-items

          echo "ğŸ“¦ Downloading items data..."
          # Get the list of files from the items folder via GitHub API
          curl -s "https://api.github.com/repos/RaidTheory/arcraiders-data/contents/items?ref=main" | \
            grep '"download_url"' | \
            cut -d'"' -f4 | \
            while read url; do
              if [[ ! -z "$url" ]]; then
                curl -s "$url" -o "temp-items/$(basename $url)"
              fi
            done

          # Merge all JSON files into one
          node -e "
            const fs = require('fs');
            const path = require('path');

            const items = [];
            const dir = 'temp-items';

            fs.readdirSync(dir).forEach(file => {
              if (file.endsWith('.json')) {
                const content = JSON.parse(fs.readFileSync(path.join(dir, file), 'utf-8'));
                items.push(content);
              }
            });

            fs.writeFileSync('items-new.json', JSON.stringify(items, null, 2));
            console.log('âœ“ Merged ' + items.length + ' items');
          "

          # Replace the current data with new data
          mv items-new.json data/items.json

          # Merge relationships from recipes/recycling
          node scripts/merge-with-metaforge.js

          # Remove duplicates
          node scripts/remove-duplicates.js

          # Generate changelog
          node scripts/generate-changelog.js

          echo "âœ… Items sync completed"

      # ===== SYNC PROJECTS =====
      - name: Sync Projects Data
        id: sync_projects
        continue-on-error: true
        run: |
          echo "ğŸ¯ Downloading projects data..."
          curl -sL "https://raw.githubusercontent.com/RaidTheory/arcraiders-data/refs/heads/main/projects.json" -o data/projects.json
          echo "âœ… Projects sync completed"

      # ===== SYNC QUESTS =====
      - name: Sync Quests Data
        id: sync_quests
        continue-on-error: true
        run: |
          mkdir -p data/quests
          cd data/quests

          echo "ğŸ“‹ Downloading quests data..."
          # Get list of quest files from GitHub API
          QUEST_FILES=$(curl -s "https://api.github.com/repos/RaidTheory/arcraiders-data/contents/quests" | \
            jq -r '.[] | select(.name | endswith(".json")) | .download_url')

          # Download each quest file
          echo "$QUEST_FILES" | while read url; do
            filename=$(basename "$url")
            echo "  - $filename"
            curl -sL "$url" -o "$filename"
          done

          echo "âœ… Quests sync completed ($(ls -1 *.json 2>/dev/null | wc -l) files)"

      # ===== REGENERATE TAGS =====
      - name: Regenerate Item Tags
        id: regenerate_tags
        continue-on-error: true
        run: |
          echo "ğŸ·ï¸  Regenerating item tags..."
          npm ci
          npm run generate-tags
          echo "âœ… Tags regenerated"

      # ===== CHECK FOR CHANGES =====
      - name: Detect Changes
        id: changes
        run: |
          # Check if any files have changed
          if git diff --quiet; then
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No changes detected"
          else
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "âœ“ Changes detected"
          fi

      # ===== GENERATE PR BODY =====
      - name: Generate PR Description
        if: steps.changes.outputs.changes_detected == 'true'
        run: |
          # Check which syncs succeeded
          ITEMS_STATUS="${{ steps.sync_items.outcome }}"
          PROJECTS_STATUS="${{ steps.sync_projects.outcome }}"
          QUESTS_STATUS="${{ steps.sync_quests.outcome }}"
          TAGS_STATUS="${{ steps.regenerate_tags.outcome }}"

          cat > pr-body.md << EOF
          ## ğŸ”„ Automated Data Synchronization

          Synchronizes all game data from [RaidTheory/arcraiders-data](https://github.com/RaidTheory/arcraiders-data).

          ### ğŸ“Š Sync Results

          | Data Type | Status | Notes |
          |-----------|:------:|-------|
          | **Items** | $([ "$ITEMS_STATUS" = "success" ] && echo "âœ…" || echo "âŒ") | $([ "$ITEMS_STATUS" = "success" ] && echo "Items data, changelog, and snapshot updated" || echo "Sync failed - check logs") |
          | **Projects** | $([ "$PROJECTS_STATUS" = "success" ] && echo "âœ…" || echo "âŒ") | $([ "$PROJECTS_STATUS" = "success" ] && echo "Projects data synchronized" || echo "Sync failed - check logs") |
          | **Quests** | $([ "$QUESTS_STATUS" = "success" ] && echo "âœ…" || echo "âŒ") | $([ "$QUESTS_STATUS" = "success" ] && echo "Quest files synchronized" || echo "Sync failed - check logs") |
          | **Item Tags** | $([ "$TAGS_STATUS" = "success" ] && echo "âœ…" || echo "âŒ") | $([ "$TAGS_STATUS" = "success" ] && echo "Tags regenerated (keep/sell/recycle)" || echo "Generation failed - check logs") |

          ### ğŸ“ Changes Included

          <details>
          <summary><b>ğŸ“¦ Items Data</b></summary>

          - Downloaded latest items from upstream
          - Merged recipe/recycling relationships
          - Removed duplicates
          - Generated changelog with detected changes
          - Updated snapshot for next sync

          </details>

          <details>
          <summary><b>ğŸ¯ Projects Data</b></summary>

          - Synchronized projects.json from upstream
          - Projects define crafting progression and unlocks

          </details>

          <details>
          <summary><b>ğŸ“‹ Quests Data</b></summary>

          - Synchronized all quest files from upstream
          - Quests influence item tag recommendations

          </details>

          <details>
          <summary><b>ğŸ·ï¸ Item Tags</b></summary>

          - Regenerated keep/sell/recycle recommendations
          - Based on latest items, projects, and quests
          - Updated tag reasons for transparency

          </details>

          ### âœ… Review Checklist

          - [ ] **Changelog** - Review changes in \`data/changelog.json\`
          - [ ] **Items Count** - Verify total items count is reasonable
          - [ ] **Tag Stats** - Check tag distribution (keep/sell/recycle ratios)
          - [ ] **No Breaking Changes** - Ensure no critical items removed
          - [ ] **Build Passes** - Verify deployment will succeed

          ### ğŸ” How to Review

          1. Check the **Files changed** tab for detailed diffs
          2. Review \`data/changelog.json\` for added/modified/removed items
          3. Look at \`data/item-tags-computed.json\` for tag changes
          4. Verify \`data/projects.json\` and \`data/quests/*.json\` if relevant

          ---
          ğŸ¤– **Automated sync** â€¢ Daily at 2 AM UTC â€¢ [Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

      # ===== CREATE PULL REQUEST =====
      - name: Create Pull Request
        if: steps.changes.outputs.changes_detected == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: sync all data from upstream

            - Items: ${{ steps.sync_items.outcome }}
            - Projects: ${{ steps.sync_projects.outcome }}
            - Quests: ${{ steps.sync_quests.outcome }}
            - Tags: ${{ steps.regenerate_tags.outcome }}
          title: 'ğŸ”„ Sync all data from RaidTheory'
          body-path: pr-body.md
          branch: sync-data-${{ github.run_number }}
          delete-branch: true
          reviewers: Teyk0o
          labels: |
            automated
            data-sync

      # ===== SUMMARY =====
      - name: Workflow Summary
        if: always()
        run: |
          echo "### ğŸ”„ Data Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|:------:|" >> $GITHUB_STEP_SUMMARY
          echo "| Items | ${{ steps.sync_items.outcome == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Projects | ${{ steps.sync_projects.outcome == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Quests | ${{ steps.sync_quests.outcome == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tags | ${{ steps.regenerate_tags.outcome == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Changes:** ${{ steps.changes.outputs.changes_detected == 'true' && 'PR created âœ“' || 'None detected' }}" >> $GITHUB_STEP_SUMMARY
