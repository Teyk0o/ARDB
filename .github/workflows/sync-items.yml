name: Sync Items Data

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download latest items data
        run: |
          mkdir -p temp-items

          # Get the list of files from the items folder via GitHub API
          curl -s "https://api.github.com/repos/RaidTheory/arcraiders-data/contents/items?ref=main" | \
            grep '"download_url"' | \
            cut -d'"' -f4 | \
            while read url; do
              if [[ ! -z "$url" ]]; then
                curl -s "$url" -o "temp-items/$(basename $url)"
              fi
            done

          # Merge all JSON files into one
          node -e "
            const fs = require('fs');
            const path = require('path');

            const items = [];
            const dir = 'temp-items';

            fs.readdirSync(dir).forEach(file => {
              if (file.endsWith('.json')) {
                const content = JSON.parse(fs.readFileSync(path.join(dir, file), 'utf-8'));
                items.push(content);
              }
            });

            fs.writeFileSync('items-new.json', JSON.stringify(items, null, 2));
            console.log('Merged ' + items.length + ' items');
          "

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Process and merge items data
        run: |
          # Replace the current data with new data
          mv items-new.json data/items.json

          # Merge relationships from recipes/recycling and build used_in references
          node scripts/merge-with-metaforge.js

          # Remove any remaining duplicates
          node scripts/remove-duplicates.js

      - name: Detect changes
        run: |
          # Compare with git to see if there are actual changes
          if git diff --quiet data/items.json; then
            echo "No changes detected"
            echo "CHANGES_DETECTED=false" >> $GITHUB_ENV
          else
            echo "Changes detected"
            echo "CHANGES_DETECTED=true" >> $GITHUB_ENV
          fi

      - name: Create branch and commit if changed
        if: env.CHANGES_DETECTED == 'true'
        run: |
          git config user.name "Arc Raiders Data Sync"
          git config user.email "sync@arcraidersdatabase.com"

          # Create a unique branch name with timestamp
          BRANCH_NAME="chore/sync-items-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"

          git add data/items.json
          git commit -m "chore: sync items data from upstream"
          git push origin "$BRANCH_NAME"

          # Save branch name for next step
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create Pull Request if changed
        if: env.CHANGES_DETECTED == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { repo, owner } = context;
            const branchName = process.env.BRANCH_NAME;

            await github.rest.pulls.create({
              owner,
              repo,
              title: "chore: sync items data from upstream",
              head: branchName,
              base: "main",
              body: `## Data Synchronization

This PR synchronizes items data from upstream (arcraiders-data).

### Details
- **Source:** RaidTheory/arcraiders-data (main branch)
- **Destination:** data/items.json
- **Type:** Data synchronization

### Process applied
1. ✅ Download latest items data
2. ✅ Merge recipe/recycling relationships
3. ✅ Build used_in references
4. ✅ Remove duplicates

### Next steps
- [ ] Review changes
- [ ] Test for potential impact
- [ ] Merge and deploy

---
Auto-generated by sync workflow`
            });

            console.log("Pull Request created successfully");

      - name: Notify if no changes
        if: env.CHANGES_DETECTED == 'false'
        run: echo "Items data is up to date"
