name: Sync Items Data

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download latest items data
        run: |
          curl -s "https://raw.githubusercontent.com/RaidTheory/arcraiders-data/refs/heads/main/items.json" \
            -o items-new.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Process and merge items data
        run: |
          # Replace the current data with new data
          mv items-new.json data/items.json

          # Merge relationships from recipes/recycling and build used_in references
          node scripts/merge-with-metaforge.js

          # Remove any remaining duplicates
          node scripts/remove-duplicates.js

      - name: Detect changes
        run: |
          # Compare with git to see if there are actual changes
          if git diff --quiet data/items.json; then
            echo "No changes detected"
            echo "CHANGES_DETECTED=false" >> $GITHUB_ENV
          else
            echo "Changes detected"
            echo "CHANGES_DETECTED=true" >> $GITHUB_ENV
          fi

      - name: Create branch and commit if changed
        if: env.CHANGES_DETECTED == 'true'
        run: |
          git config user.name "Arc Raiders Data Sync"
          git config user.email "sync@arcraidersdatabase.com"

          # Create a unique branch name with timestamp
          BRANCH_NAME="chore/sync-items-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"

          git add data/items.json
          git commit -m "chore: sync items data from upstream"
          git push origin "$BRANCH_NAME"

          # Save branch name for next step
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create Pull Request if changed
        if: env.CHANGES_DETECTED == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { repo, owner } = context;
            const branchName = process.env.BRANCH_NAME;

            const pr = await github.rest.pulls.create({
              owner,
              repo,
              title: "chore: sync items data from upstream",
              head: branchName,
              base: "main",
              body: `## üìä Items Data Synchronization

Cette PR synchronise les donn√©es d'items depuis le repository en amont (\`arcraiders-data\`).

### üîç D√©tails
- **Source:** RaidTheory/arcraiders-data (branche main)
- **Destination:** data/items.json
- **Type:** Synchronisation de donn√©es

### üîß Processus appliqu√©
1. ‚úÖ T√©l√©chargement des derni√®res donn√©es d'items
2. ‚úÖ Fusion des relations recettes/recyclage
3. ‚úÖ Construction des r√©f√©rences "used_in"
4. ‚úÖ Suppression des doublons

### ‚ú® Prochaines √©tapes
- [ ] Revue des changements
- [ ] Test des impacts √©ventuels
- [ ] Fusion et d√©ploiement

---
*G√©n√©r√©e automatiquement par le workflow de synchronisation*`
            });

            console.log(`Pull Request cr√©√©e: #${pr.data.number}`);

      - name: Notify if no changes
        if: env.CHANGES_DETECTED == 'false'
        run: echo "Items data is up to date"
